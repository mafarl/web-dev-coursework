<?php
  // Start the session
  session_start();
  include 'navbar.php'; 

  // Check if the leaderboard data exists in the session
  if (!isset($_SESSION['leaderboard'])) {
    // Initialize the leaderboard data in the session
    $_SESSION['leaderboard'] = array();
  }

  // Add a submission to the leaderboard
  function add_submission($username, $level_1_score, $level_2_score, $level_3_score) {
    // Get the leaderboard data from the session
    $leaderboard = $_SESSION['leaderboard'];

    // Check if the user already has a submission in the leaderboard
    if (isset($leaderboard[$username])) {
      // Update the user's scores if they have a higher score
      if ($level_1_score > $leaderboard[$username]['level_1_score']) {
        $leaderboard[$username]['level_1_score'] = $level_1_score;
      }
      if ($level_2_score > $leaderboard[$username]['level_2_score']) {
        $leaderboard[$username]['level_2_score'] = $level_2_score;
      }
      if ($level_3_score > $leaderboard[$username]['level_3_score']) {
        $leaderboard[$username]['level_3_score'] = $level_3_score;
      }
    } else {
      // Add a new submission for the user
      $leaderboard[$username] = array(
        'level_1_score' => $level_1_score,
        'level_2_score' => $level_2_score,
        'level_3_score' => $level_3_score,
      );
    }

    // Calculate the total score for each user
    foreach ($leaderboard as $username => $scores) {
      $total_score = $scores['level_1_score'] + $scores['level_2_score'] + $scores['level_3_score'];
      $leaderboard[$username]['total_score'] = $total_score;
    }

    // Sort the leaderboard by total score in descending order
    uasort($leaderboard, function($a, $b) {
      return $b['total_score'] - $a['total_score'];
    });

    // Store the leaderboard data back in the session
    $_SESSION['leaderboard'] = $leaderboard;
  }

  if (isset($_POST['level_scores'])) {
    $unsplit = $_POST['level_scores'];
    $scores_array = explode(",", $unsplit);
    add_submission($_SESSION["username"], $scores_array[0], $scores_array[1], $scores_array[2]);   
  }


  // Display the leaderboard table
?>
<!DOCTYPE html>
<html>
<head>
  <title>Leaderboard</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">

  <style>
    .leaderboard {
      box-shadow: 5px 5px 5px #888888;
      padding: 20px;
    }
    
    table {
      border-collapse: collapse;
      border-spacing: 2px;
      margin-top: 20px;
    }
    
    th {
      background-color: blue;
      color: white;
      font-weight: bold;
    }

    td {
      background-color: #f2f2f2;
    }
    
    td, th {
      padding: 10px;
      text-align: center;
      border: 1px solid black;
    }

    h2 {
      color: #f2f2f2;
    }

    #wrapper-leaderboard{
      background-color: grey;
      box-shadow: 5px;
    }
  </style>
</head>
<body>
  <div id="main" class="leaderboard">
    <img id="backgroundimage" src="background.jpg" border="0" alt="">

    <div id="wrapper-leaderboard">
      <h2>Leaderboard</h2>
      <table>
        <thead>
          <tr>
            <th>Place</th>
            <th>Username</th>
            <th>Level 1 Score</th>
            <th>Level 2 Score</th>
            <th>Level 3 Score</th>
            <th>Total Score</th>
          </tr>
        </thead>
        <tbody>
          <?php
              $i = 1;
              // Loop through the leaderboard data and display each user's scores
              foreach ($_SESSION['leaderboard'] as $username => $scores) {
              echo '<tr>';
              echo '<td>' . $i . '</td>'; 
              echo '<td>' . $username . '</td>';
              echo '<td>' . $scores['level_1_score'] . '</td>';
              echo '<td>' . $scores['level_2_score'] . '</td>';
              echo '<td>' . $scores['level_3_score'] . '</td>';
              echo '<td>' . $scores['total_score'] . '</td>';
              echo '</tr>';
              $i = $i + 1;
              }
          ?>
          </tbody>
      </table>
    </div>

    </div>
</body>
</html>